
#Область ОбработчикиСобытий

Процедура ОбработкаПроведения(Отказ, Режим)
	
	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Записывать = Истина;
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записать();
	
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записывать = Истина;
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записать();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВКМ_ОбслуживаниеКлиентов.Клиент КАК Клиент,
	|	ВКМ_ОбслуживаниеКлиентов.Договор КАК Договор,
	|	ВКМ_ОбслуживаниеКлиентов.Договор.ВидДоговора КАК ВидДоговора,
	|	ВКМ_ОбслуживаниеКлиентов.Договор.ВКМ_НачалоДействияДоговора КАК НачалоДействияДоговора,
	|	ВКМ_ОбслуживаниеКлиентов.Договор.ВКМ_ОкончаниеДействияДоговора КАК ОкончаниеДействияДоговора,
	|	ВКМ_ОбслуживаниеКлиентов.Договор.ВКМ_СтоимостьЧасаРаботы КАК СтоимостьЧасаРаботы,
	|	СУММА(ВКМ_ОбслуживаниеКлиентовВыполненныеРаботы.ЧасыКОплатеКлиенту) КАК ЧасыКОплатеКлиенту,
	|	ВКМ_ОбслуживаниеКлиентов.Специалист КАК Специалист
	|ПОМЕСТИТЬ ВТ_ДанныеДокумента
	|ИЗ
	|	Документ.ВКМ_ОбслуживаниеКлиентов.ВыполненныеРаботы КАК ВКМ_ОбслуживаниеКлиентовВыполненныеРаботы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВКМ_ОбслуживаниеКлиентов КАК ВКМ_ОбслуживаниеКлиентов
	|		ПО ВКМ_ОбслуживаниеКлиентовВыполненныеРаботы.Ссылка = ВКМ_ОбслуживаниеКлиентов.Ссылка
	|ГДЕ
	|	ВКМ_ОбслуживаниеКлиентов.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	ВКМ_ОбслуживаниеКлиентов.Клиент,
	|	ВКМ_ОбслуживаниеКлиентов.Договор,
	|	ВКМ_ОбслуживаниеКлиентов.Договор.ВидДоговора,
	|	ВКМ_ОбслуживаниеКлиентов.Договор.ВКМ_НачалоДействияДоговора,
	|	ВКМ_ОбслуживаниеКлиентов.Договор.ВКМ_ОкончаниеДействияДоговора,
	|	ВКМ_ОбслуживаниеКлиентов.Договор.ВКМ_СтоимостьЧасаРаботы,
	|	ВКМ_ОбслуживаниеКлиентов.Специалист
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ВКМ_УсловияОплатыСотрудниковСрезПоследних.ПроцентОтРабот) КАК ПроцентОтРаботСпециалиста,
	|	ВКМ_УсловияОплатыСотрудниковСрезПоследних.Сотрудник КАК Сотрудник
	|ПОМЕСТИТЬ ВТ_ДанныеОплатыСпециалиста
	|ИЗ
	|	РегистрСведений.ВКМ_УсловияОплатыСотрудников.СрезПоследних(
	|			&Дата,
	|			Сотрудник В
	|				(ВЫБРАТЬ
	|					ВТ_ДанныеДокумента.Специалист КАК Специалист
	|				ИЗ
	|					ВТ_ДанныеДокумента КАК ВТ_ДанныеДокумента)) КАК ВКМ_УсловияОплатыСотрудниковСрезПоследних
	|
	|СГРУППИРОВАТЬ ПО
	|	ВКМ_УсловияОплатыСотрудниковСрезПоследних.Сотрудник
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ДанныеДокумента.Клиент КАК Клиент,
	|	ВТ_ДанныеДокумента.Договор КАК Договор,
	|	ВТ_ДанныеДокумента.ВидДоговора КАК ВидДоговора,
	|	ВТ_ДанныеДокумента.НачалоДействияДоговора КАК НачалоДействияДоговора,
	|	ВТ_ДанныеДокумента.ОкончаниеДействияДоговора КАК ОкончаниеДействияДоговора,
	|	ВТ_ДанныеДокумента.СтоимостьЧасаРаботы КАК СтоимостьЧасаРаботы,
	|	ВТ_ДанныеДокумента.ЧасыКОплатеКлиенту КАК ЧасыКОплатеКлиенту,
	|	ВТ_ДанныеДокумента.Специалист КАК Специалист,
	|	ВТ_ДанныеОплатыСпециалиста.ПроцентОтРаботСпециалиста КАК ПроцентОтРаботСпециалиста
	|ИЗ
	|	ВТ_ДанныеОплатыСпециалиста КАК ВТ_ДанныеОплатыСпециалиста
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДанныеДокумента КАК ВТ_ДанныеДокумента
	|		ПО (ВТ_ДанныеДокумента.Специалист = ВТ_ДанныеОплатыСпециалиста.Сотрудник)";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("Дата", Дата);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если Выборка.ВидДоговора <> Перечисления.ВидыДоговоровКонтрагентов.ВКМ_АбоненскоеОбслуживание Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = "Необходимо выбрать договор: Абоненское обслуживание.";
			Сообщение.Сообщить();
			Отказ = Истина;
			
		КонецЕсли;
		
		Если Дата > Выборка.ОкончаниеДействияДоговора Или Дата < Выборка.НачалоДействияДоговора Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = "Дата документа, не соответствует, периоду действия договора Абоненского обслуживания.";
			Сообщение.Сообщить();
			Отказ = Истина;
		КонецЕсли;
		
		//ПроцентОтРаботСпециалиста - тип строка,  если не установлен, документ не проводится,
		//если установлен, то приводится к числу, так как процент может быть равен 0
		Если Не ЗначениеЗаполнено(Выборка.ПроцентОтРаботСпециалиста) Тогда 
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = СтрШаблон("Не установлен процент отплаты специалисту: %1. Проведение документа не возможно.", Выборка.Специалист);
			Сообщение.Сообщить();
			Отказ = Истина;
		Иначе ПроцентОтРаботСпециалиста = Число(Выборка.ПроцентОтРаботСпециалиста);
			
		КонецЕсли;
		
		// Регистр  ВКМ_ВыполненныеКлиентуРаботы
		Если ВыполненныеРаботы.Количество() <> 0 Тогда
			
			Движение = Движения.ВКМ_ВыполненныеКлиентуРаботы.Добавить();
			Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
			Движение.Период = Дата;
			Движение.Клиент = Выборка.Клиент;
			Движение.Договор = Выборка.Договор;
			Движение.КоличествоЧасов = Выборка.ЧасыКОплатеКлиенту;
			Движение.СуммаЗаВыполненныеРаботы = Движение.КоличествоЧасов * Выборка.СтоимостьЧасаРаботы;
			
		Иначе Продолжить; 
			
		КонецЕсли;
		
	КонецЦикла;
	
	//Регистр ВКМ_ВыполненныеСотрудникомРаботы 
	Если ВыполненныеРаботы.Количество() <> 0 Тогда
		
		СуммаКОплате = Движение.СуммаЗаВыполненныеРаботы;
		ЧасовКОплате = Движение.КоличествоЧасов;
		
		Движение = Движения.ВКМ_ВыполненныеСотрудникомРаботы.Добавить();
		Движение.Период = Дата;
		Движение.Сотрудник = Специалист;
		Движение.ЧасовКОплате = ЧасовКОплате;
		Движение.СуммаКОплате = СуммаКОплате / 100 * ПроцентОтРаботСпециалиста;
		
	Иначе Возврат;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	ДополнительныеСвойства.Вставить("ЭтоНовый", ЭтоНовый());
	
КонецПроцедуры 

Процедура ПриЗаписи(Отказ)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	Если ДополнительныеСвойства.ЭтоНовый Тогда
		
		НовоеСообщение = Справочники.ВКМ_УведомленияТелеграмБоту.СоздатьЭлемент();
		НовоеСообщение.ТекстСообщения = СтрШаблон("Новая Завяка № %1.Клиент: %2. Дата проведения работ: %3. Время начала: %4. Время окончания:%5. Специалист: %6",
		Номер,
		Клиент,
		Формат(ДатаПроведенияРабот, "ДФ=dd.MM.yyyy"),
		Формат(ВремяНачалаРабот,"ДЛФ=T"),
		Формат(ВремяОкончанияРабот, "ДЛФ=T"), 
		Специалист);
		НовоеСообщение.Записать();
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
